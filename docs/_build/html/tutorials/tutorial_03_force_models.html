

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Training a model on forces and energies &mdash; SchNetPack 1.0rc documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> SchNetPack
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getstarted/getstarted.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getstarted/getstarted.html#scripts-for-benchmark-data-sets">Scripts for benchmark data sets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getstarted/getstarted.html#using-scripts-with-custom-datasets">Using Scripts with custom Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getstarted/getstarted.html#using-argument-files-for-training">Using Argument Files for Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getstarted/getstarted.html#supported-models">Supported Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getstarted/getstarted.html#benchmark-datasets">Benchmark Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getstarted/getstarted.html#references">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getstarted/benchmarks.html">Benchmarks and Trained Models</a></li>
</ul>
<p class="caption"><span class="caption-text">Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules/base.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">schnetpack</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/data.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">schnetpack.data</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/datasets.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">schnetpack.datasets</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/environment.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">schnetpack.environment</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/nn.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">schnetpack.nn</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/representation.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">schnetpack.representation</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/atomistic.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">schnetpack.atomistic</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/train.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">schnetpack.train</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/md.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">schnetpack.md</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/utils.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">schnetpack.utils</span></code></a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">SchNetPack</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Training a model on forces and energies</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/tutorials/tutorial_03_force_models.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 5ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Training-a-model-on-forces-and-energies">
<h1>Training a model on forces and energies<a class="headerlink" href="#Training-a-model-on-forces-and-energies" title="Permalink to this headline">¶</a></h1>
<p>In addition to the energy, machine learning models can also be used to model molecular forces. These are <span class="math notranslate nohighlight">\(N_\mathrm{atoms} \times 3\)</span> arrays describing the Cartesian force acting on each atom due to the overall (potential) energy. They are formally defined as the negative gradient of the energy <span class="math notranslate nohighlight">\(E_\mathrm{pot}\)</span> with respect to the nuclear positions <span class="math notranslate nohighlight">\(\mathbf{R}\)</span></p>
<div class="math notranslate nohighlight">
\begin{equation}
\mathbf{F}^{(\alpha)} = -\frac{\partial E_\mathrm{pot}}{\partial \mathbf{R}^{(\alpha)}},
\end{equation}</div><p>where <span class="math notranslate nohighlight">\(\alpha\)</span> is the index of the nucleus.</p>
<p>The above expression offers a straightforward way to include forces in machine learning models by simply defining a model for the energy and taking the appropriate derivatives. The resulting model can directly be trained on energies and forces. Moreover, in this manner energy conservation and the correct behaviour under rotations of the molecule is guaranteed.</p>
<p>Using forces in addition to energies to construct a machine learning model offers several advantages. Accurate force predictions are important for molecular dynamics simulations, which will be covered in the subsequent tutorial. Forces also encode a greater wealth of information than the energies. For every molecule, only one energy is present, while there are <span class="math notranslate nohighlight">\(3N_\mathrm{atoms}\)</span> force entries. This property, combined with the fact that reference forces can be computed at the same cost as
energies, makes models trained on forces and energies very data efficient.</p>
<p>In the following, we will show how to train such force models and how to use them in practical applications.</p>
<div class="section" id="Preparing-the-data">
<h2>Preparing the data<a class="headerlink" href="#Preparing-the-data" title="Permalink to this headline">¶</a></h2>
<p>The process of preparing the data is smilar to the tutorial on <a class="reference internal" href="tutorial_02_qm9.html"><span class="doc">QM9</span></a>. We begin by importing all relevant packages and generating a directory for the tutorial experiments.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">schnetpack</span> <span class="k">as</span> <span class="nn">spk</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">forcetut</span> <span class="o">=</span> <span class="s1">&#39;./forcetut&#39;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">forcetut</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">forcetut</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Next, the data needs to be loaded from a suitable dataset. For convenience, we use the MD17 dataset class provided in SchNetPack, which automtically downloads and builds suitable databases containing energies and forces for a range of small organic molecules. In this case, we use the ethanol molecule as an example.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">schnetpack.datasets</span> <span class="k">import</span> <span class="n">MD17</span>

<span class="n">ethanol_data</span> <span class="o">=</span> <span class="n">MD17</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">forcetut</span><span class="p">,</span><span class="s1">&#39;ethanol.db&#39;</span><span class="p">),</span> <span class="n">molecule</span><span class="o">=</span><span class="s1">&#39;ethanol&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>For custom datasets, the data would have to be loaded via the SchNetPack <code class="docutils literal notranslate"><span class="pre">AtomsData</span></code> class. In this case, one needs to make sure, that the naming of properties is kept consistent. The <code class="docutils literal notranslate"><span class="pre">schnetpack.Properties</span></code> module provides standard names for a wide range of properties. Here, we use the definitions provided with the <code class="docutils literal notranslate"><span class="pre">MD17</span></code> class.</p>
<p>In order to train force models, forces need to be included in the reference data. Once the dataset was loaded, this can e.g. be checked by calling the <code class="docutils literal notranslate"><span class="pre">get_properties</span></code> function for sample entries. Here we look at the configuration with the index 0. The function returns an ASE <code class="docutils literal notranslate"><span class="pre">Atoms</span></code> object and a dictionary containing the loaded properties:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">atoms</span><span class="p">,</span> <span class="n">properties</span> <span class="o">=</span> <span class="n">ethanol_data</span><span class="o">.</span><span class="n">get_properties</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loaded properties:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="o">*</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{:s}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">properties</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Loaded properties:
 energy
 forces
 _atomic_numbers
 _positions
 _cell
 _neighbors
 _cell_offset

</pre></div></div>
</div>
<p>As can be seen, <code class="docutils literal notranslate"><span class="pre">energy</span></code> and <code class="docutils literal notranslate"><span class="pre">forces</span></code> are included in the properties dictionary. To have a look at the <code class="docutils literal notranslate"><span class="pre">forces</span></code> array and check whether it has the expected dimensions, we can call:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Forces:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">properties</span><span class="p">[</span><span class="n">MD17</span><span class="o">.</span><span class="n">forces</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Shape:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">properties</span><span class="p">[</span><span class="n">MD17</span><span class="o">.</span><span class="n">forces</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Forces:
 tensor([[ 1.4517e+00,  6.0192e+00,  5.2068e-07],
        [ 1.7953e+01, -5.1624e+00,  3.4900e-07],
        [-4.0884e+00,  2.2590e+01,  3.3088e-06],
        [-1.1416e+00, -9.7469e+00,  7.6473e+00],
        [-1.1416e+00, -9.7469e+00, -7.6473e+00],
        [-2.4821e+00,  4.9335e+00,  4.3700e+00],
        [-2.4821e+00,  4.9335e+00, -4.3700e+00],
        [-5.5148e+00, -3.0207e+00, -8.9093e-09],
        [-2.4393e+00, -1.0838e+01, -6.0721e-08]])
Shape:
 torch.Size([9, 3])
</pre></div></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">atoms</span></code> object can e.g. be used to visualize the ethanol molecule:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">ase.visualize</span> <span class="k">import</span> <span class="n">view</span>
<span class="n">view</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">viewer</span><span class="o">=</span><span class="s1">&#39;x3d&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<html>

 <head>

  <title>ASE atomic visualization</title>

  <link rel="stylesheet" type="text/css"

   href="https://www.x3dom.org/x3dom/release/x3dom.css">

  </link>

  <script type="text/javascript"

   src="https://www.x3dom.org/x3dom/release/x3dom.js">

  </script>

 </head>

 <body>

  <X3D style="margin:0; padding:0; width:100%; height:100%; border:none;">

   <Scene>

    <Transform translation="0.01 -0.57 0.00">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.565 0.565 0.565" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="0.76">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="-1.29 0.25 0.00">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.565 0.565 0.565" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="0.76">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="1.13 0.31 0.00">

     <Shape>

      <Appearance>

       <Material diffuseColor="1.000 0.051 0.051" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="0.66">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="0.04 -1.20 0.89">

     <Shape>

      <Appearance>

       <Material diffuseColor="1.000 1.000 1.000" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="0.31">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="0.04 -1.20 -0.89">

     <Shape>

      <Appearance>

       <Material diffuseColor="1.000 1.000 1.000" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="0.31">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="-1.32 0.88 0.89">

     <Shape>

      <Appearance>

       <Material diffuseColor="1.000 1.000 1.000" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="0.31">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="-1.32 0.88 -0.89">

     <Shape>

      <Appearance>

       <Material diffuseColor="1.000 1.000 1.000" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="0.31">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="-2.14 -0.42 0.00">

     <Shape>

      <Appearance>

       <Material diffuseColor="1.000 1.000 1.000" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="0.31">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="1.99 -0.14 0.00">

     <Shape>

      <Appearance>

       <Material diffuseColor="1.000 1.000 1.000" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="0.31">

      </Sphere>

     </Shape>

    </Transform>

   </Scene>

  </X3D>

 </body>

</html></div>
</div>
<p>Next, the data is split into training (1000 points), test (500 points) and validation set (remainder) and data loaders are created. This is done in the same way as described in the <a class="reference internal" href="tutorial_02_qm9.html"><span class="doc">QM9 tutorial</span></a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">train</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">spk</span><span class="o">.</span><span class="n">train_test_split</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">ethanol_data</span><span class="p">,</span>
        <span class="n">num_train</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">num_val</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">split_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">forcetut</span><span class="p">,</span> <span class="s2">&quot;split.npz&quot;</span><span class="p">),</span>
    <span class="p">)</span>

<span class="n">train_loader</span> <span class="o">=</span> <span class="n">spk</span><span class="o">.</span><span class="n">AtomsLoader</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">val_loader</span> <span class="o">=</span> <span class="n">spk</span><span class="o">.</span><span class="n">AtomsLoader</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Once again, we want to use the mean and standardeviation of the energies in the training data to precondition our model. This only needs to be done for the energies, since the forces are obtained as derivatives and automatically capture the scale of the data. Unlike in the case of QM9, the subtraction of atomic reference energies is not necessary, since only configurations of the same molecule are loaded. All this can be done via the <code class="docutils literal notranslate"><span class="pre">get_statistics</span></code> function of the <code class="docutils literal notranslate"><span class="pre">AtomsLoader</span></code> class:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">means</span><span class="p">,</span> <span class="n">stddevs</span> <span class="o">=</span> <span class="n">train_loader</span><span class="o">.</span><span class="n">get_statistics</span><span class="p">(</span>
    <span class="n">spk</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">MD17</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">get_atomwise_statistics</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Mean atomization energy / atom:      </span><span class="si">{:12.4f}</span><span class="s1"> [kcal/mol]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">means</span><span class="p">[</span><span class="n">MD17</span><span class="o">.</span><span class="n">energy</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Std. dev. atomization energy / atom: </span><span class="si">{:12.4f}</span><span class="s1"> [kcal/mol]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stddevs</span><span class="p">[</span><span class="n">MD17</span><span class="o">.</span><span class="n">energy</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Mean atomization energy / atom:       -10799.5244 [kcal/mol]
Std. dev. atomization energy / atom:       0.4679 [kcal/mol]
</pre></div></div>
</div>
</div>
<div class="section" id="Building-the-model">
<h2>Building the model<a class="headerlink" href="#Building-the-model" title="Permalink to this headline">¶</a></h2>
<p>After having prepared the data in the above way, we can now build and train the force model. This is done in the same two steps as described in <a class="reference internal" href="tutorial_02_qm9.html"><span class="doc">QM9 tutorial</span></a>:</p>
<ol class="arabic simple">
<li><p>Building the representation</p></li>
<li><p>Defining an output module</p></li>
</ol>
<p>For the representation we can use the same <code class="docutils literal notranslate"><span class="pre">SchNet</span></code> layer as in the previous tutorial:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">n_features</span> <span class="o">=</span> <span class="mi">128</span>

<span class="n">schnet</span> <span class="o">=</span> <span class="n">spk</span><span class="o">.</span><span class="n">representation</span><span class="o">.</span><span class="n">SchNet</span><span class="p">(</span>
    <span class="n">n_atom_basis</span><span class="o">=</span><span class="n">n_features</span><span class="p">,</span>
    <span class="n">n_filters</span><span class="o">=</span><span class="n">n_features</span><span class="p">,</span>
    <span class="n">n_gaussians</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
    <span class="n">n_interactions</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">cutoff</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span>
    <span class="n">cutoff_network</span><span class="o">=</span><span class="n">spk</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">cutoff</span><span class="o">.</span><span class="n">CosineCutoff</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>Since we want to model forces, the <code class="docutils literal notranslate"><span class="pre">Atomwise</span></code> output module needs to be adapted slightly. We will still use one module to predict the energy, preconditioning with the mean and standard deviation per atom of the energy.</p>
<p>However, since the forces should be described as the derivative of the energy, we have to indicate that the corresponding derviative of the model should be computed. This is done by specifying <code class="docutils literal notranslate"><span class="pre">derivative=MD17.forces</span></code>, which also assigns the computed derivative to the property <code class="docutils literal notranslate"><span class="pre">MD17.forces</span></code>. Since the forces are the negative gradient, we also need to enable <code class="docutils literal notranslate"><span class="pre">negative_dr=True</span></code>, which simply multipiies the derviative with -1.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">energy_model</span> <span class="o">=</span> <span class="n">spk</span><span class="o">.</span><span class="n">atomistic</span><span class="o">.</span><span class="n">Atomwise</span><span class="p">(</span>
    <span class="n">n_in</span><span class="o">=</span><span class="n">n_features</span><span class="p">,</span>
    <span class="nb">property</span><span class="o">=</span><span class="n">MD17</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span>
    <span class="n">mean</span><span class="o">=</span><span class="n">means</span><span class="p">[</span><span class="n">MD17</span><span class="o">.</span><span class="n">energy</span><span class="p">],</span>
    <span class="n">stddev</span><span class="o">=</span><span class="n">stddevs</span><span class="p">[</span><span class="n">MD17</span><span class="o">.</span><span class="n">energy</span><span class="p">],</span>
    <span class="n">derivative</span><span class="o">=</span><span class="n">MD17</span><span class="o">.</span><span class="n">forces</span><span class="p">,</span>
    <span class="n">negative_dr</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>Both modules are then combined to an <code class="docutils literal notranslate"><span class="pre">AtomisticModel</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">model</span> <span class="o">=</span> <span class="n">spk</span><span class="o">.</span><span class="n">AtomisticModel</span><span class="p">(</span><span class="n">representation</span><span class="o">=</span><span class="n">schnet</span><span class="p">,</span> <span class="n">output_modules</span><span class="o">=</span><span class="n">energy_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Training-the-model">
<h2>Training the model<a class="headerlink" href="#Training-the-model" title="Permalink to this headline">¶</a></h2>
<p>To train the model on energies and forces, we need to update the loss function to include the latter. This combined loss function is:</p>
<div class="math notranslate nohighlight">
\begin{equation}
\mathcal{L}(E_\mathrm{ref},\mathbf{F}_\mathrm{ref},E_\mathrm{pred}, \mathbf{F}_\mathrm{pred}) = \frac{1}{n_\text{train}} \sum_{n=1}^{n_\text{train}} \left[  \rho \left( E_\mathrm{ref} - E_\mathrm{pred} \right)^2  +  \frac{(1-\rho)}{3N_\mathrm{atoms}} \sum^{N_\mathrm{atoms}}_\alpha \left\| \mathbf{F}_\mathrm{ref}^{(\alpha)} - \mathbf{F}_\mathrm{pred}^{(\alpha)} \right\|^2 \right],
\end{equation}</div><p>where we take the predicted forces to be:</p>
<div class="math notranslate nohighlight">
\begin{equation}
\mathbf{F}_\mathrm{pred}^{(\alpha)} = -\frac{\partial E_\mathrm{pred}}{\partial \mathbf{R}^{(\alpha)}}.
\end{equation}</div><p>We have introduced a parameter <span class="math notranslate nohighlight">\(\rho\)</span> in order to control the tradeoff between energy and force loss. By varying this parameter, the accuracy on energies and forces can be tuned. Setting <span class="math notranslate nohighlight">\(\rho=0\)</span> only forces are trained, while in the case of <span class="math notranslate nohighlight">\(\rho=1\)</span> only energies are learned. Using PyTorch, we can implement this loss function in the following way:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">torch</span>

<span class="c1"># tradeoff</span>
<span class="n">rho_tradeoff</span> <span class="o">=</span> <span class="mf">0.1</span>

<span class="c1"># loss function</span>
<span class="k">def</span> <span class="nf">loss</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
    <span class="c1"># compute the mean squared error on the energies</span>
    <span class="n">diff_energy</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="n">MD17</span><span class="o">.</span><span class="n">energy</span><span class="p">]</span><span class="o">-</span><span class="n">result</span><span class="p">[</span><span class="n">MD17</span><span class="o">.</span><span class="n">energy</span><span class="p">]</span>
    <span class="n">err_sq_energy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_energy</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># compute the mean squared error on the forces</span>
    <span class="n">diff_forces</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="n">MD17</span><span class="o">.</span><span class="n">forces</span><span class="p">]</span><span class="o">-</span><span class="n">result</span><span class="p">[</span><span class="n">MD17</span><span class="o">.</span><span class="n">forces</span><span class="p">]</span>
    <span class="n">err_sq_forces</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_forces</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># build the combined loss function</span>
    <span class="n">err_sq</span> <span class="o">=</span> <span class="n">rho_tradeoff</span><span class="o">*</span><span class="n">err_sq_energy</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">rho_tradeoff</span><span class="p">)</span><span class="o">*</span><span class="n">err_sq_forces</span>

    <span class="k">return</span> <span class="n">err_sq</span>
</pre></div>
</div>
</div>
<p>Next, we procede in the same manner as in the <a class="reference internal" href="tutorial_02_qm9.html"><span class="doc">QM9 tutorial</span></a>. First, we specify that the Adam optimizer from PyTorch should be used to train the model:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">torch.optim</span> <span class="k">import</span> <span class="n">Adam</span>

<span class="c1"># build optimizer</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">5e-4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Then, we construct the trainer hooks to monitor the training process and anneal the learning rate. Since we also learn forces in addition to the energies, we include a corresponding metric into the logger.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># before setting up the trainer, remove previous training checkpoints and logs</span>
<span class="o">%</span><span class="k">rm</span> -rf ./forcetut/checkpoints
<span class="o">%</span><span class="k">rm</span> -rf ./forcetut/log.csv

<span class="kn">import</span> <span class="nn">schnetpack.train</span> <span class="k">as</span> <span class="nn">trn</span>

<span class="c1"># set up metrics</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">spk</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">MeanAbsoluteError</span><span class="p">(</span><span class="n">MD17</span><span class="o">.</span><span class="n">energy</span><span class="p">),</span>
    <span class="n">spk</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">MeanAbsoluteError</span><span class="p">(</span><span class="n">MD17</span><span class="o">.</span><span class="n">forces</span><span class="p">)</span>
<span class="p">]</span>

<span class="c1"># construct hooks</span>
<span class="n">hooks</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">trn</span><span class="o">.</span><span class="n">CSVHook</span><span class="p">(</span><span class="n">log_path</span><span class="o">=</span><span class="n">forcetut</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">),</span>
    <span class="n">trn</span><span class="o">.</span><span class="n">ReduceLROnPlateauHook</span><span class="p">(</span>
        <span class="n">optimizer</span><span class="p">,</span>
        <span class="n">patience</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">min_lr</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span>
        <span class="n">stop_after_min</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<p>Finally, we build the SchNetPack <code class="docutils literal notranslate"><span class="pre">Trainer</span></code> and pass the optimizer, loss function, hooks and data loaders.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">trainer</span> <span class="o">=</span> <span class="n">trn</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span>
    <span class="n">model_path</span><span class="o">=</span><span class="n">forcetut</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
    <span class="n">hooks</span><span class="o">=</span><span class="n">hooks</span><span class="p">,</span>
    <span class="n">loss_fn</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span>
    <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
    <span class="n">train_loader</span><span class="o">=</span><span class="n">train_loader</span><span class="p">,</span>
    <span class="n">validation_loader</span><span class="o">=</span><span class="n">val_loader</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>We then train our model for 300 epochs, which should take approximately 10 minutes on a notebook GPU.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># check if a GPU is available and use a CPU otherwise</span>
<span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
    <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cpu&quot;</span>

<span class="c1"># determine number of epochs and train</span>
<span class="n">n_epochs</span> <span class="o">=</span> <span class="mi">300</span>
<span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">n_epochs</span><span class="o">=</span><span class="n">n_epochs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Training will produce several files in the <code class="docutils literal notranslate"><span class="pre">model_path</span></code> directory, which is <code class="docutils literal notranslate"><span class="pre">forcetut</span></code> in our case. The split is stored in <code class="docutils literal notranslate"><span class="pre">split.npz</span></code>. Checkpoints are written to <code class="docutils literal notranslate"><span class="pre">checkpoints</span></code> periodically, which can be used to restart training. A copy of the best model is stored in <code class="docutils literal notranslate"><span class="pre">best_model</span></code>, which can directly be accessed using the <code class="docutils literal notranslate"><span class="pre">torch.load</span></code> function. Since we specified the CSV logger, the training progress is saved to <code class="docutils literal notranslate"><span class="pre">log.csv</span></code>.</p>
<p>Using the CSV file, the training progress can be vizualized. An example showing the evolution of the mean absolute errors (MAEs) during training is shown below. Besides the <code class="docutils literal notranslate"><span class="pre">schnetpack.train.CSVHook</span></code>, it is also possible to use the <code class="docutils literal notranslate"><span class="pre">schnetpack.train.tensorboardHook</span></code>. This makes it possible to monitor the training in real time with TensorBoard.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">ase.units</span> <span class="k">import</span> <span class="n">kcal</span><span class="p">,</span> <span class="n">mol</span>

<span class="c1"># Load logged results</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">forcetut</span><span class="p">,</span> <span class="s1">&#39;log.csv&#39;</span><span class="p">),</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

<span class="c1"># Determine time axis</span>
<span class="n">time</span> <span class="o">=</span> <span class="n">results</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Load the validation MAEs</span>
<span class="n">energy_mae</span> <span class="o">=</span> <span class="n">results</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span>
<span class="n">forces_mae</span> <span class="o">=</span> <span class="n">results</span><span class="p">[:,</span><span class="mi">5</span><span class="p">]</span>

<span class="c1"># Get final validation errors</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Validation MAE:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    energy: </span><span class="si">{:10.3f}</span><span class="s1"> kcal/mol&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">energy_mae</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    forces: </span><span class="si">{:10.3f}</span><span class="s1"> kcal/mol/</span><span class="se">\u212B</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">forces_mae</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

<span class="c1"># Construct figure</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="c1"># Plot energies</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">energy_mae</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Energy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;MAE [kcal/mol]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time [s]&#39;</span><span class="p">)</span>

<span class="c1"># Plot forces</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">forces_mae</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Forces&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;MAE [kcal/mol/</span><span class="se">\u212B</span><span class="s1">]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time [s]&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation MAE:
    energy:      0.414 kcal/mol
    forces:      1.099 kcal/mol/Å
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_tutorial_03_force_models_32_1.png" src="../_images/tutorials_tutorial_03_force_models_32_1.png" />
</div>
</div>
<p>It should be noted, that the model trained here is used exclusively for demonstrative purposes. Accordingly, its size and the training time have been reduced significantly. This puts strong constraints on the accuracy that can be obtained. For practical applications, one would e.g. increase the number of features, the interaction layers, the learning rate schedule and train until convergence (removing the <code class="docutils literal notranslate"><span class="pre">n_epochs</span></code> keyword from the <code class="docutils literal notranslate"><span class="pre">trainer</span></code>).</p>
<p>SchNetPack also provides the script <code class="docutils literal notranslate"><span class="pre">schnetpack_md17.py</span></code>, which fully automates the whole training process for MD17 and comes with a series of reasonable default settings.</p>
</div>
<div class="section" id="Using-the-model">
<h2>Using the model<a class="headerlink" href="#Using-the-model" title="Permalink to this headline">¶</a></h2>
<p>Since all models in SchNetPack are stored in the same way, we can use the trained force model in exactly the same manner as described in the <a class="reference internal" href="tutorial_02_qm9.html"><span class="doc">QM9 tutorial</span></a>.</p>
<p>To load the model stored in the <code class="docutils literal notranslate"><span class="pre">best_model</span></code> file, we use the <code class="docutils literal notranslate"><span class="pre">torch.load</span></code> function. It will automatically be moved to the device it was trained on.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">best_model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">forcetut</span><span class="p">,</span> <span class="s1">&#39;best_model&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>To evaluate its performance on the test data, we use an adapted version of the loop introduced in the previous tutorial. Since the MD17 dataset of ethanol contains approximately 550 000 configurations, the full evaluation takes approximately 10 minutes on GPU.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">test_loader</span> <span class="o">=</span> <span class="n">spk</span><span class="o">.</span><span class="n">AtomsLoader</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="n">energy_error</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">forces_error</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_loader</span><span class="p">):</span>
    <span class="c1"># move batch to GPU, if necessary</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="c1"># apply model</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">best_model</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

    <span class="c1"># calculate absolute error of energies</span>
    <span class="n">tmp_energy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pred</span><span class="p">[</span><span class="n">MD17</span><span class="o">.</span><span class="n">energy</span><span class="p">]</span> <span class="o">-</span> <span class="n">batch</span><span class="p">[</span><span class="n">MD17</span><span class="o">.</span><span class="n">energy</span><span class="p">]))</span>
    <span class="n">tmp_energy</span> <span class="o">=</span> <span class="n">tmp_energy</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="c1"># detach from graph &amp; convert to numpy</span>
    <span class="n">energy_error</span> <span class="o">+=</span> <span class="n">tmp_energy</span>

    <span class="c1"># calculate absolute error of forces, where we compute the mean over the n_atoms x 3 dimensions</span>
    <span class="n">tmp_forces</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pred</span><span class="p">[</span><span class="n">MD17</span><span class="o">.</span><span class="n">forces</span><span class="p">]</span> <span class="o">-</span> <span class="n">batch</span><span class="p">[</span><span class="n">MD17</span><span class="o">.</span><span class="n">forces</span><span class="p">]),</span> <span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="n">tmp_forces</span> <span class="o">=</span> <span class="n">tmp_forces</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="c1"># detach from graph &amp; convert to numpy</span>
    <span class="n">forces_error</span> <span class="o">+=</span> <span class="n">tmp_forces</span>

    <span class="c1"># log progress</span>
    <span class="n">percent</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:3.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">count</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">test_loader</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Progress:&#39;</span><span class="p">,</span> <span class="n">percent</span><span class="o">+</span><span class="s1">&#39;%&#39;</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">*</span><span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">percent</span><span class="p">)),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">energy_error</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
<span class="n">forces_error</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Test MAE:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    energy: </span><span class="si">{:10.3f}</span><span class="s1"> kcal/mol&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">energy_error</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    forces: </span><span class="si">{:10.3f}</span><span class="s1"> kcal/mol/</span><span class="se">\u212B</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">forces_error</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Progress: 99.98%
Test MAE:
    energy:      0.396 kcal/mol
    forces:      1.100 kcal/mol/Å
</pre></div></div>
</div>
</div>
<div class="section" id="Interface-to-ASE">
<h2>Interface to ASE<a class="headerlink" href="#Interface-to-ASE" title="Permalink to this headline">¶</a></h2>
<p>As was shown in the <a class="reference internal" href="tutorial_02_qm9.html"><span class="doc">QM9 tutorial</span></a>, one can also use the <code class="docutils literal notranslate"><span class="pre">AtomsConverter</span></code> to directly operate on ASE atoms objects.</p>
<p>Having access to molecular forces also makes it possible to perform a variety of different simulations. The <code class="docutils literal notranslate"><span class="pre">SpkCalculator</span></code> offers a simple way to perform all computations available in the ASE package. Below, we create an ASE calculator from the trained model and the previously generated <code class="docutils literal notranslate"><span class="pre">atoms</span></code> object (see <a class="reference external" href="#Preparing-the-data">Preparing the data</a>). One important point is, that the MD17 dataset uses kcal/mol and kcal/mol/Å as units for energies and forces. For the ASE interface, these
need to be converted to the standard internal ASE units eV and eV/Å. This can be done by either passing the conversion factor or a string denoting the unit to the keywords <code class="docutils literal notranslate"><span class="pre">energy_units</span></code> and <code class="docutils literal notranslate"><span class="pre">force_units</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">calculator</span> <span class="o">=</span> <span class="n">spk</span><span class="o">.</span><span class="n">interfaces</span><span class="o">.</span><span class="n">SpkCalculator</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">best_model</span><span class="p">,</span>
    <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
    <span class="n">energy</span><span class="o">=</span><span class="n">MD17</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span>
    <span class="n">forces</span><span class="o">=</span><span class="n">MD17</span><span class="o">.</span><span class="n">forces</span><span class="p">,</span>
    <span class="n">energy_units</span><span class="o">=</span><span class="s1">&#39;kcal/mol&#39;</span><span class="p">,</span>
    <span class="n">forces_units</span><span class="o">=</span><span class="s1">&#39;kcal/mol/A&#39;</span>
<span class="p">)</span>

<span class="n">atoms</span><span class="o">.</span><span class="n">set_calculator</span><span class="p">(</span><span class="n">calculator</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Prediction:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;energy:&#39;</span><span class="p">,</span> <span class="n">atoms</span><span class="o">.</span><span class="n">get_total_energy</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;forces:&#39;</span><span class="p">,</span> <span class="n">atoms</span><span class="o">.</span><span class="n">get_forces</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Prediction:
energy: [-4215.326]
forces: [[ 4.8149731e-02  2.2211398e-01 -8.2710464e-08]
 [ 7.8540379e-01 -2.2908500e-01 -3.1016423e-08]
 [-9.7170897e-02  1.0150807e+00 -4.1355232e-08]
 [-2.6240392e-02 -4.0961695e-01  3.1710267e-01]
 [-2.6240392e-02 -4.0961662e-01 -3.1710231e-01]
 [-1.2042553e-01  2.2401318e-01  1.8506417e-01]
 [-1.2042536e-01  2.2401318e-01 -1.8506417e-01]
 [-3.1431168e-01 -1.4146599e-01 -2.2616142e-08]
 [-1.2873909e-01 -4.9543568e-01 -4.2001407e-09]]
</pre></div></div>
</div>
<p>Among the simulations which can be done by using ASE and a force model are geometry optimisation, normal mode analysis and simple molecular dynamics simulations.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">AseInterface</span></code> of SchNetPack offers a convenient way to perform basic versions of these computations. Only a file specifying the geometry of the molecule and a pretrained model are needed.</p>
<p>We will first generate a XYZ file containing an ethanol configuration:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">ase</span> <span class="k">import</span> <span class="n">io</span>

<span class="c1"># Generate a directory for the ASE computations</span>
<span class="n">ase_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">forcetut</span><span class="p">,</span> <span class="s1">&#39;ase_calcs&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ase_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">ase_dir</span><span class="p">)</span>

<span class="c1"># Write a sample molecule</span>
<span class="n">molecule_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">ase_dir</span><span class="p">,</span> <span class="s1">&#39;ethanol.xyz&#39;</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">molecule_path</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;xyz&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">AseInterface</span></code> is initialized by passing the path to the molecule, the model and a computation directory. In addion, the computation device for the force model and how energies and forces are called in the output, as well as their units, need to be provided.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ethanol_ase</span> <span class="o">=</span> <span class="n">spk</span><span class="o">.</span><span class="n">interfaces</span><span class="o">.</span><span class="n">AseInterface</span><span class="p">(</span>
    <span class="n">molecule_path</span><span class="p">,</span>
    <span class="n">best_model</span><span class="p">,</span>
    <span class="n">ase_dir</span><span class="p">,</span>
    <span class="n">device</span><span class="p">,</span>
    <span class="n">energy</span><span class="o">=</span><span class="n">MD17</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span>
    <span class="n">forces</span><span class="o">=</span><span class="n">MD17</span><span class="o">.</span><span class="n">forces</span><span class="p">,</span>
    <span class="n">energy_units</span><span class="o">=</span><span class="s1">&#39;kcal/mol&#39;</span><span class="p">,</span>
    <span class="n">forces_units</span><span class="o">=</span><span class="s1">&#39;kcal/mol/A&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="Geometry-optimization">
<h3>Geometry optimization<a class="headerlink" href="#Geometry-optimization" title="Permalink to this headline">¶</a></h3>
<p>For some applications it is neccessary to relax a molecule to an energy minimum. In order to perform this optimization of the molecular geometry, we can simply call</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ethanol_ase</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">fmax</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
                Step[ FC]     Time          Energy          fmax
BFGSLineSearch:    0[  0] 14:04:31    -4215.326172        1.0197
BFGSLineSearch:    1[  2] 14:04:31    -4215.358887        0.6782
BFGSLineSearch:    2[  4] 14:04:31    -4215.370117        0.3471
BFGSLineSearch:    3[  6] 14:04:31    -4215.373535        0.2088
BFGSLineSearch:    4[  8] 14:04:31    -4215.376465        0.1770
BFGSLineSearch:    5[ 10] 14:04:31    -4215.377441        0.0837
BFGSLineSearch:    6[ 12] 14:04:31    -4215.377930        0.0413
BFGSLineSearch:    7[ 15] 14:04:31    -4215.377930        0.0323
BFGSLineSearch:    8[ 16] 14:04:31    -4215.378418        0.0184
BFGSLineSearch:    9[ 17] 14:04:31    -4215.378418        0.0042
BFGSLineSearch:   10[ 19] 14:04:31    -4215.378418        0.0022
BFGSLineSearch:   11[ 20] 14:04:31    -4215.378418        0.0016
BFGSLineSearch:   12[ 22] 14:04:31    -4215.378418        0.0028
BFGSLineSearch:   13[ 23] 14:04:31    -4215.378418        0.0022
BFGSLineSearch:   14[ 25] 14:04:31    -4215.378418        0.0018
BFGSLineSearch:   15[ 28] 14:04:31    -4215.378418        0.0006
BFGSLineSearch:   16[ 29] 14:04:31    -4215.378418        0.0001
</pre></div></div>
</div>
<p>Since we trained only a reduced model, the accuracy of energies and forces is not optimal and several steps are needed to optimize the geometry.</p>
</div>
<div class="section" id="Normal-mode-analysis">
<h3>Normal mode analysis<a class="headerlink" href="#Normal-mode-analysis" title="Permalink to this headline">¶</a></h3>
<p>Once the geometry was optimized, normal mode frequencies can be obtained from the Hessian (matrix of second derivatives) of the molecule. The Hessian is a measure of the curvature of the potential energy surface and normal mode frequencies are useful for determining, whether an optimization has reached a minimum. Using the <code class="docutils literal notranslate"><span class="pre">AseInterface</span></code>, normal mode frequencies can be obtained via:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ethanol_ase</span><span class="o">.</span><span class="n">compute_normal_modes</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Writing ./forcetut/ase_calcs/normal_modes.eq.pckl
Writing ./forcetut/ase_calcs/normal_modes.0x-.pckl
Writing ./forcetut/ase_calcs/normal_modes.0x+.pckl
Writing ./forcetut/ase_calcs/normal_modes.0y-.pckl
Writing ./forcetut/ase_calcs/normal_modes.0y+.pckl
Writing ./forcetut/ase_calcs/normal_modes.0z-.pckl
Writing ./forcetut/ase_calcs/normal_modes.0z+.pckl
Writing ./forcetut/ase_calcs/normal_modes.1x-.pckl
Writing ./forcetut/ase_calcs/normal_modes.1x+.pckl
Writing ./forcetut/ase_calcs/normal_modes.1y-.pckl
Writing ./forcetut/ase_calcs/normal_modes.1y+.pckl
Writing ./forcetut/ase_calcs/normal_modes.1z-.pckl
Writing ./forcetut/ase_calcs/normal_modes.1z+.pckl
Writing ./forcetut/ase_calcs/normal_modes.2x-.pckl
Writing ./forcetut/ase_calcs/normal_modes.2x+.pckl
Writing ./forcetut/ase_calcs/normal_modes.2y-.pckl
Writing ./forcetut/ase_calcs/normal_modes.2y+.pckl
Writing ./forcetut/ase_calcs/normal_modes.2z-.pckl
Writing ./forcetut/ase_calcs/normal_modes.2z+.pckl
Writing ./forcetut/ase_calcs/normal_modes.3x-.pckl
Writing ./forcetut/ase_calcs/normal_modes.3x+.pckl
Writing ./forcetut/ase_calcs/normal_modes.3y-.pckl
Writing ./forcetut/ase_calcs/normal_modes.3y+.pckl
Writing ./forcetut/ase_calcs/normal_modes.3z-.pckl
Writing ./forcetut/ase_calcs/normal_modes.3z+.pckl
Writing ./forcetut/ase_calcs/normal_modes.4x-.pckl
Writing ./forcetut/ase_calcs/normal_modes.4x+.pckl
Writing ./forcetut/ase_calcs/normal_modes.4y-.pckl
Writing ./forcetut/ase_calcs/normal_modes.4y+.pckl
Writing ./forcetut/ase_calcs/normal_modes.4z-.pckl
Writing ./forcetut/ase_calcs/normal_modes.4z+.pckl
Writing ./forcetut/ase_calcs/normal_modes.5x-.pckl
Writing ./forcetut/ase_calcs/normal_modes.5x+.pckl
Writing ./forcetut/ase_calcs/normal_modes.5y-.pckl
Writing ./forcetut/ase_calcs/normal_modes.5y+.pckl
Writing ./forcetut/ase_calcs/normal_modes.5z-.pckl
Writing ./forcetut/ase_calcs/normal_modes.5z+.pckl
Writing ./forcetut/ase_calcs/normal_modes.6x-.pckl
Writing ./forcetut/ase_calcs/normal_modes.6x+.pckl
Writing ./forcetut/ase_calcs/normal_modes.6y-.pckl
Writing ./forcetut/ase_calcs/normal_modes.6y+.pckl
Writing ./forcetut/ase_calcs/normal_modes.6z-.pckl
Writing ./forcetut/ase_calcs/normal_modes.6z+.pckl
Writing ./forcetut/ase_calcs/normal_modes.7x-.pckl
Writing ./forcetut/ase_calcs/normal_modes.7x+.pckl
Writing ./forcetut/ase_calcs/normal_modes.7y-.pckl
Writing ./forcetut/ase_calcs/normal_modes.7y+.pckl
Writing ./forcetut/ase_calcs/normal_modes.7z-.pckl
Writing ./forcetut/ase_calcs/normal_modes.7z+.pckl
Writing ./forcetut/ase_calcs/normal_modes.8x-.pckl
Writing ./forcetut/ase_calcs/normal_modes.8x+.pckl
Writing ./forcetut/ase_calcs/normal_modes.8y-.pckl
Writing ./forcetut/ase_calcs/normal_modes.8y+.pckl
Writing ./forcetut/ase_calcs/normal_modes.8z-.pckl
Writing ./forcetut/ase_calcs/normal_modes.8z+.pckl
---------------------
  #    meV     cm^-1
---------------------
  0    2.3i     18.3i
  1    1.2i      9.7i
  2    0.1i      0.6i
  3    0.0i      0.2i
  4    0.1       0.7
  5    0.7       5.4
  6   23.0     185.5
  7   29.1     234.8
  8   51.1     412.1
  9  102.0     823.0
 10  108.7     876.9
 11  126.9    1023.1
 12  131.6    1061.6
 13  143.6    1158.3
 14  153.6    1238.6
 15  155.4    1253.3
 16  165.4    1334.4
 17  173.9    1402.6
 18  177.4    1430.8
 19  182.4    1471.0
 20  185.4    1495.2
 21  360.7    2909.2
 22  366.1    2953.0
 23  372.4    3004.0
 24  382.1    3081.9
 25  382.6    3085.6
 26  466.8    3764.8
---------------------
Zero-point energy: 2.120 eV
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/mitx/anaconda3/envs/schnet_debug/lib/python3.6/site-packages/ase/vibrations/vibrations.py:355: ComplexWarning: Casting complex values to real discards the imaginary part
  fd.write(&#39;Mode #%d, f = %.1f%s cm^-1&#39; % (n, f[n], c))
</pre></div></div>
</div>
<p>Imaginary frequencies indicate, that the geometry optimisation has not yet reached a minimum. The <code class="docutils literal notranslate"><span class="pre">AseInterface</span></code> also creates an <code class="docutils literal notranslate"><span class="pre">normal_modes.xyz</span></code> file which can be used to visualize the vibrations with jmol.</p>
</div>
<div class="section" id="Molecular-dynamics">
<h3>Molecular dynamics<a class="headerlink" href="#Molecular-dynamics" title="Permalink to this headline">¶</a></h3>
<p>Finally, it is also possible to basic run molecular dynamics simulations using this interface. To do so, we first need to prepare the system, where we specify the simulation file. This routine automatically initializes the velocities of the atoms to a random number corresponding to a certain average kinetic energy.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ethanol_ase</span><span class="o">.</span><span class="n">init_md</span><span class="p">(</span>
    <span class="s1">&#39;simulation&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>The actual simulation is performed by calling the function <code class="docutils literal notranslate"><span class="pre">run_md</span></code> with a certain number of steps:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ethanol_ase</span><span class="o">.</span><span class="n">run_md</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>During simulation, energies and geometries are logged to <code class="docutils literal notranslate"><span class="pre">simulation.log</span></code> and <code class="docutils literal notranslate"><span class="pre">simulation.traj</span></code>, respectively.</p>
<p>We can for example visualize the evolution of the systems total and potential energies as</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Load logged results</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ase_dir</span><span class="p">,</span> <span class="s1">&#39;simulation.log&#39;</span><span class="p">),</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Determine time axis</span>
<span class="n">time</span> <span class="o">=</span> <span class="n">results</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Load energies</span>
<span class="n">energy_tot</span> <span class="o">=</span> <span class="n">results</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">energy_pot</span> <span class="o">=</span> <span class="n">results</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
<span class="n">energy_kin</span> <span class="o">=</span> <span class="n">results</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span>

<span class="c1"># Construct figure</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

<span class="c1"># Plot energies</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">energy_tot</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Total energy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">energy_pot</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Potential energy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;E [eV]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">energy_kin</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Kinetic energy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;E [eV]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time [ps]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">temperature</span> <span class="o">=</span> <span class="n">results</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Average temperature: </span><span class="si">{:10.2f}</span><span class="s1"> K&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">temperature</span><span class="p">)))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Average temperature:     170.79 K
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_tutorial_03_force_models_53_1.png" src="../_images/tutorials_tutorial_03_force_models_53_1.png" />
</div>
</div>
<p>As can be seen, the potential and kinetic energies fluctuate, while the total energy (sum of potential and kinetic energy) remains approximately constant. This is a good demonstration for the energy conservation obtained by modeling forces as energy derivatives. Unfortunately, this also means that energy conservation is not a sufficient measure for the quality of the potential.</p>
<p>However, frequently one is interested in simulations where the system is coupled to an external heat bath. This is the same as saying that we wish to keep the average kinetic energy of the system and hence temperature close a certain value. Currently the average temperature only depends on the random velocities drawn during the initialization of the dynamics. Keeping a constant temperature average be achived by using a so-called thermostat. In the <code class="docutils literal notranslate"><span class="pre">AseInterface</span></code>, simulations with a thermostat
(to be precise a Langevin thermostat) can be carried out by providing the <code class="docutils literal notranslate"><span class="pre">temp_bath</span></code> keyword. A simulation with e.g. the target temperature of 300K is performed via:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ethanol_ase</span><span class="o">.</span><span class="n">init_md</span><span class="p">(</span>
    <span class="s1">&#39;simulation_300K&#39;</span><span class="p">,</span>
    <span class="n">temp_bath</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">reset</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">ethanol_ase</span><span class="o">.</span><span class="n">run_md</span><span class="p">(</span><span class="mi">20000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We can now once again plot total and potential energies. Instead of the kinetic energy, we now plot the temperature (both quantities are directly related).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Load logged results</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ase_dir</span><span class="p">,</span> <span class="s1">&#39;simulation_300K.log&#39;</span><span class="p">),</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Determine time axis</span>
<span class="n">time</span> <span class="o">=</span> <span class="n">results</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
<span class="c1">#0.02585</span>
<span class="c1"># Load energies</span>
<span class="n">energy_tot</span> <span class="o">=</span> <span class="n">results</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">energy_pot</span> <span class="o">=</span> <span class="n">results</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>

<span class="c1"># Construct figure</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

<span class="c1"># Plot energies</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">energy_tot</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Total energy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">energy_pot</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Potential energy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Energies [eV]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Plot Temperature</span>
<span class="n">temperature</span> <span class="o">=</span> <span class="n">results</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span>

<span class="c1"># Compute average temperature</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Average temperature: </span><span class="si">{:10.2f}</span><span class="s1"> K&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">temperature</span><span class="p">)))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Simulation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Temperature [K]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time [ps]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span><span class="o">*</span><span class="mi">300</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Target&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Average temperature:     263.97 K
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_tutorial_03_force_models_57_1.png" src="../_images/tutorials_tutorial_03_force_models_57_1.png" />
</div>
</div>
<p>Since our molecule is now subjected to external influences via the thermostat the total energy is no longer conserved. However, the simulation temperature now fluctuates near to the requested 300K. This can also be seen by computing the temperature average over time, which is now close to the desired value in contrast to the previous simulation.</p>
</div>
</div>
<div class="section" id="Summary">
<h2>Summary<a class="headerlink" href="#Summary" title="Permalink to this headline">¶</a></h2>
<p>In this tutorial, we have trained a SchNet model on energies and forces using the MD17 ethanol dataset as an example. We have then evaluated the performance of the model and performed geometry optimisation, normal mode analysis and basic molecular dynamic simulations using the SchNetPack ASE interface.</p>
<p>While these simulations can already be useful for practical applications, SchNetPack also comes with its own molecular dynamics package. This package makes it possible to run efficient simulations on GPU and also offers access to advanced techniques, such as ring polymer dynamics. In the next tutorial, we will cover how to perform molecular dynamics simulations directly with SchNetPack.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Wujie Wang, Daniel Schwalbe-Koda

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>